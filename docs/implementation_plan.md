# Think Bot RE 实施路线图

本文档基于需求说明（`docs/desc.md`）与技术设计（`docs/tech_design.md`），拆解重构任务，指导团队按阶段迭代交付完整的浏览器扩展。每一阶段都需同步更新文档、补充测试并验证 Chrome MV3 限制下的运行情况。

## 0. 基础约定

- **文档同步**：每次提交必须更新相关设计/使用文档，记录范围和接口变更。
- **测试优先**：所有模块提供最小单元/集成测试，关键流程使用 Playwright 进行端到端验证。
- **Chrome 合规**：Manifest 权限最小化，遵循 Service Worker 生命周期，避免长驻全局状态。
- **可观测性**：后台统一日志格式，必要时输出结构化错误，方便未来接入遥测。

## 1. 核心基础设施阶段

| 子任务 | 说明 | 交付物 | 状态 |
| --- | --- | --- | --- |
| 1.1 工程基线 | 配置 ESLint、Prettier、Tailwind、Vitest、Playwright、别名与路径映射。 | 配置文件、CI 脚本草案、测试样例 | ✅ 已完成 |
| 1.2 存储 Schema | 基于 `lib/storage/schema.ts` 定义完整配置结构、默认值、迁移策略。 | Zod Schema、默认配置测试 | ✅ 已完成 |
| 1.3 消息总线 | 丰富 `lib/messaging` 与 `background/router`，定义消息契约、错误处理与类型守卫。 | 消息类型定义、示例处理器、单元测试 | ✅ 已完成 |
| 1.4 状态存储 | 在 `store/` 中实现 Sidebar/Options 的 Zustand Store，并与 Storage 快照对齐。 | Store 模块、状态同步测试 | ✅ 已完成 |
| 1.5 国际化内核 | 完成 `lib/i18n`、语言包加载、`useTranslation`，并编写样例组件。 | i18n Provider、语言切换测试 | ✅ 已完成 |

## 2. 内容提取与同步阶段

| 子任务 | 说明 | 交付物 | 状态 |
| --- | --- | --- | --- |
| 2.1 DOM 提取脚本 | 在 `contents/extractor.ts` 和 `background/services/extractor.ts` 中完成 Readability/Jina 双模式，含错误兜底。 | 提取服务、模拟网页测试 | ✅ 已完成 |
| 2.2 页面状态管理 | 设计后台页面缓存（按 Tab Key），提供刷新、清除、重试逻辑。 | PageStateService、消息处理测试 | ✅ 已完成 |
| 2.3 云同步服务 | 在 `background/services/sync.ts` 实现 Gist/WebDAV Provider，支持手动/自动同步与错误提示。 | 同步服务、HTTP Mock 测试 | ✅ 已完成 |

## 3. LLM 调度与对话阶段

| 子任务 | 说明 | 交付物 | 状态 |
| --- | --- | --- | --- |
| 3.1 LLM Provider 接口 | 实现抽象接口与工厂，封装 OpenAI/Gemini/Azure/Bedrock SDK，统一响应格式。 | Provider 模块、契约测试 | ✅ 已完成 |
| 3.2 流式响应 | 在 `background/services/llm/streaming.ts` 实现分片拼装、状态广播、错误恢复。 | Streaming 工具、单元测试 | ✅ 已完成 |
| 3.3 对话记录 | 设计聊天存储结构、导出 Markdown、分支消息支持。 | Conversation Store、导出测试 | ✅ 已完成 |
| 3.4 图片与多模态 | 定义图片粘贴/上传流程，扩展消息协议，确保兼容不支持图片的模型。 | 图片处理模块、条件测试 | ✅ 已完成 |

> **进度快照（对话阶段）**：OpenAI/Gemini/Azure/Bedrock Provider 已落地，ConversationService 支持附件与分支消息回写，侧边栏可在多模型并行流式场景下渲染进度。新增针对 LLM 工厂降级与多模型消息路由异常分支的单元测试，后续集中补充图片模型适配与 Playwright 覆盖。

## 4. UI 交互阶段

| 子任务 | 说明 | 交付物 | 状态 |
| --- | --- | --- | --- |
| 4.1 Sidebar 布局 | 搭建四区布局（顶部控制、内容展示、快捷指令、聊天区），实现响应式与可拖拽高度。 | Sidebar 组件、视觉回归测试 | ✅ 已完成 |
| 4.2 快捷指令 | 实现 Tab 管理、自动触发、分支模型列表与状态提示。 | Quick Tabs 组件、状态测试 | ✅ 已完成 |
| 4.3 对话操作 | 悬浮按钮、编辑/重试/复制/分支/跳转等交互，流式渲染。 | 消息组件、交互测试 | ✅ 已完成 |
| 4.4 Options 页面 | 构建多页配置表单、拖拽排序、导入导出、云同步控制面板。 | Options 组件、表单校验测试 | ✅ 已完成 |
| 4.5 Conversations 页面 | 历史页面列表、搜索、详情查看与同步状态提示。 | Conversations 页面、E2E 测试 | ✅ 已完成 |
| 4.6 Tutorial Tab | 首次使用教程内容、引导流程与跳转逻辑。 | 教程页面、内容测试 | ✅ 已完成 |

## 5. 质量与发布阶段

| 子任务 | 说明 | 交付物 | 状态 |
| --- | --- | --- | --- |
| 5.1 Playwright 流程 | 编写覆盖关键路径的 E2E 脚本（内容提取、对话、同步）。 | Playwright 测试、CI 集成 | ✅ 已完成 |
| 5.2 性能与体积 | 优化打包体积、使用 `scripts/build-icons.ts`、分析 Service Worker 生命周期。 | 构建报告、体积监控 | ✅ 已完成 |
| 5.3 发布准备 | 完成 manifest 审核条目、隐私声明、版本日志。 | 打包脚本、发布清单 | ✅ 已完成 |

> 支撑资产：新增 `tests/e2e/basic.spec.ts` Playwright 脚本、`scripts/report-bundle-size.ts` 体积分析工具、`scripts/prepare-release.ts` manifest 检查脚本与《[发布前检查清单](./release_checklist.md)》。

## 6. 持续改进建议

- 建立自动化 CI（Lint、Unit、E2E、打包）和预提交钩子。
- 记录每个阶段的测试覆盖率，设置阈值逐步提高。
- 规划未来特性：团队协作、更多模型、浏览器兼容（Firefox/Edge）。

> **执行策略**：按照阶段推进，每完成一个子任务必须：
> 1. 更新或新增相关文档（需求对齐、接口说明、使用指南）。
> 2. 编写或完善单元/集成测试，并运行 `pnpm test` / `pnpm test:e2e`（视任务场景而定）。
> 3. 通过代码评审，确认遵循 MV3 限制与安全要求。

## 7. 现状评估

为确保路线图执行与需求保持一致，请在每个阶段结束时对照《[功能覆盖检查报告](./gap_analysis.md)》更新以下内容：

- 标记表格中各子任务的完成度（完成、进行中、未开始），必要时拆分为更细的交付清单。
- 将发现的缺口转化为后续迭代的显式任务，并在 PR 描述中引用对应章节说明。
- 在评审前至少运行一次相关测试（单元/集成/E2E），并将结果附在 PR 中。
- 若需求发生变化，同步更新本路线图与技术设计文档，保持三者一致。

> **提示**：首次评估已记录在《功能覆盖检查报告》中，后续提交应以此为基线持续跟踪。

## 8. 下一阶段迭代计划（2024-Q3 Sprint 1）

本阶段聚焦《功能覆盖检查报告》中优先级最高的缺口：**会话管理** 与 **入门引导**。目标是在两次迭代内补齐历史记录管理与教程引导的核心流程，并同步完善回归测试。

| 里程碑 | 目标 / 关联缺口 | 关键任务 | 验收标准 | 负责人 | 状态 |
| --- | --- | --- | --- | --- | --- |
| M1：会话管理增强 | 关闭 Gap #3「会话 / 教程页」中会话检索、管理操作缺失的问题 | 1) 建立搜索与筛选；2) 支持重命名、删除；3) 替换导出按钮为批量操作预留位 | Conversations Tab 提供搜索、重命名、删除与导出操作，并通过单元测试验证后端能力 | 开发 | ✅ 已完成 |
| M2：教程引导流程 | 关闭 Gap #3 中「教程页」缺乏引导的问题 | 1) 设计步骤化教程；2) 加入 CTA 跳转 Sidebar；3) 编写内容测试 | Tutorial Tab 呈现步骤导航并能跳转到 Sidebar，附带文案测试 | 开发 | ✅ 已完成 |
| M3：对话服务补强 | 衔接 Gap #4「后台服务」中会话缺乏附件/元信息维护的问题 | 1) ConversationService 支持元数据更新；2) 记录更新时间；3) 覆盖单元测试 | ConversationService 支持附件、分支与多模型流式响应，单元测试覆盖 rename/remove 与附件传输 | 开发 | ✅ 已完成 |

> **进度同步**：每个里程碑完成后需在「状态」列更新完成度，并在 PR 描述中引用本表格对应的任务编号。

> 进度同步（2025-10-06）：历史记录页面补充内联重命名、来源链接与附件预览，左侧列表支持拖拽调宽与按 URL 搜索；后台 `ConversationService` 增加元数据清洗与排序单测，作为 Gap #3 的收尾工作写入最新提交。

## 9. 下一阶段迭代计划（2024-Q3 Sprint 2）

针对《功能覆盖检查报告》中重新识别的历史会话续聊缺口，本阶段聚焦让 Conversations 页面具备与 Sidebar 一致的续聊与快捷指令体验，并补充列表维护工具与测试。

| 里程碑 | 目标 / 关联缺口 | 关键任务 | 验收标准 | 状态 |
| --- | --- | --- | --- | --- |
| M5：历史会话续聊 | 关闭 Gap #3 中“Conversations 缺乏续聊入口”的问题 | 1) 新增快捷指令区与模型选择器；2) 提供消息输入区并复用后台 `conversation:append`；3) 保持搜索、重命名、删除等既有能力 | 历史页面可直接发送消息并触发多模型分支，UI 与 Sidebar 一致，错误态可视 | ✅ 已完成 |
| M5-T1：列表维护 | 确保续聊后会话列表保持按更新时间排序 | 1) 提炼排序工具；2) 续聊/重命名后自动置顶；3) 编写单元测试验证排序 | ✅ 已完成 |

> 进度同步（2025-10-07）：完成历史页面续聊能力与快捷指令自动触发，新增排序工具与单元测试，Gap #3 中的续聊缺口正式关闭并同步至覆盖报告。

# Think Bot RE 功能、UI 与交互描述文档

本文档旨在全面描述 Think Bot RE 浏览器扩展的核心功能、用户界面 (UI) 和交互流程，为项目未来的重构或重新开发提供清晰、准确的蓝图。

## 1. 核心理念

Think Bot 是一个强大的浏览器辅助工具，其核心理念是让用户能够与任何网页进行智能对话。它通过提取网页正文内容，结合用户输入，利用大型语言模型 (LLM) 的能力，实现对页面内容的总结、问答、翻译、分析等多种功能。

## 2. 核心页面

项目主要由以下几个核心页面构成：

-   侧边栏 (Sidebar): 核心交互界面，用户与网页和 LLM 对话的主要场所。
-   会话页面 (Conversations): 一个独立的页面，用于集中管理和回顾所有历史聊天记录。除内容提取外，包含Sidebar的所有功能。
-   选项页面 (Options): 用于全面配置扩展的各项功能，包括模型、同步、外观等。
-   教程页面 (Tourial): 用于首次启动时，展示一个单独的教程页面

其他模块：
-   后台脚本 (Background): 扩展的大脑，负责所有核心逻辑、数据处理和通信。
-   内容脚本 (Content Script): 注入到网页中，负责按需提供页面 HTML 内容。

## 3. 侧边栏 (Sidebar)

侧边栏是用户使用频率最高的界面，设计紧凑且功能强大。

### 3.1. UI 布局

侧边栏从上到下分为四个主要区域：

1.  顶部控制和提取内容展示:
    顶部控制栏
    -   左侧:
        -   内容提取方式切换: 提供 "Jina AI" 和 "Readability.js" (R) 两种模式的切换按钮组。
        -   操作按钮: 包括“复制提取内容”和“重新提取”两个图标按钮。
    -   右侧:
        -   页面管理: 包括“清除当前页面所有数据”、“打开独立的会话历史页面”和“打开选项页面”三个图标按钮。

内容展示区
    -   显示从当前网页自动提取出的正文内容。
    -   该区域的高度可以通过底部的拖拽柄自由调整。
    -   在内容加载时会显示动画，加载失败则显示错误提示。

2.  快捷指令区:
    -   以 Tab 标签页的形式呈现，第一个为默认的CHAT tab，其他为Quick Input Tabs。
        - chat tab：固定在第一位的、独立于用户自定义快捷指令的特殊标签页，始终存在，无预设prompt
        - Quick Input Tabs：用户可以点击不同的 Tab 快速发送预设的指令 (Prompt)，在配置页面配置。
            - 聊天区用户消息实际发送预设的指令，但显示配置的display text.
            - 配置了分支模型列表时，使用分支消息的方式调用列表的模型
    -   tab 加载状态：文字下方彩条自左向右绿橙渐变动态
    -   tab 有数据状态：文字下方彩条蓝色
    -   切换tab时，自动跳转到最后一条消息的开始处
    
    
3.  聊天交互区:
    -   对话记录: 显示用户与 LLM 的完整对话流。代码块、列表等 Markdown 格式会被正确渲染。
        - 消息都为全宽，使用背景色区分，用户消息背景色为淡蓝色。
        - 加载状态：展示模型名称，圆圈loading，停止并删除当前消息按钮
        - 分支消息：同一轮回复可能有多个分支，即调用多个模型（可重复）产生的回复。回复并排多列显示，每一个消息都有单独的状态和悬浮按钮组。
          - 当有分支时，悬浮按钮底部增加一个模型名称的展示
          - 构建对话历史时，每轮取分支消息的第一个
        - 大模型错误时直接显示原始的大模型回复json        
    -   图片预览: 当用户粘贴图片时，会在输入框上方出现一个小的预览窗口，并可移除图片。
    -   输入区域:
        -   文本输入框: 支持多行输入，高度可拖拽调整。
        -   模型选择器: 位于输入框右上角的下拉菜单，允许用户在已配置的多个 LLM 之间切换。
        -   功能按钮组: 围绕在输入框周围，布局会根据输入框高度动态调整（从单行变为网格或单列）。
            -   发送: 主操作按钮。
            -   附带页面内容: 一个开关按钮，决定发送消息时是否将“内容展示区”的文本作为上下文一并提交，默认开启。
            -   停止并清空: 点击可中断生成，并清空tab的整个对话记录。
            -   导出对话: 将当前对话保存为 Markdown 文件。导出的 Markdown 文件会包含完整的对话记录，用户的提问会以引用的形式展示，模型的回答则为正文。
- 悬浮按钮: 在对话记录区域，当鼠标悬停在某条消息上时，会显示一组悬浮按钮，包括：
    用户消息按顺序包含：编辑，重试，复制文本，复制markdown按钮
    回复消息按顺序包含：跳转顶部，复制文本，复制markdown，分支，跳转底部
    按钮：
    - 跳转顶部: 滚动到该条消息的顶部。
    - 跳转底部: 滚动到该条消息的底部。
    - 分支: 点击后出现大模型下拉列表，选择模型后，会在当前消息右侧新开一列，并排展示新选择模型的结果。
    - 复制文本: 复制该条消息的完整文本内容。
    - 复制markdown: 复制该条消息的完整markdown内容。
    - 重试: 用同样的内容重新向模型提问。
    - 编辑: 允许用户修改已发送的问题，并重新提交。

    悬浮按钮始终在页面右侧，不随长消息的滚动移动。根据消息的像素高度，布局可能为一行，两行...到完全竖排。

    

### 3.2. 交互流程与功能

-   自动提取: 用户在某个网页上打开侧边栏时，扩展会自动在后台提取该页面的正文并显示在“内容展示区”。
-   发送消息: 用户在输入框输入问题，点击“发送”。后台会根据当前选择的模型和“附带页面内容”开关的状态，组装最终的 Prompt 发送给 LLM。
-   流式响应: LLM 的回答会以打字机的效果实时显示在对话记录中，无需等待完全生成。
-   上下文感知: 用户的连续提问会基于之前的对话历史，形成多轮对话。
-   快捷指令: 点击快捷指令区的 Tab，会将预设的文本直接发送给 LLM。快捷指令可被配置为“自动触发”，即在侧边栏打开并提取完内容后自动执行。
    -   已有数据时，不触发自动执行

-   多模态输入: 支持用户直接粘贴图片到输入框，图片将和文本一起发送给支持多模态输入的 LLM。
-   黑名单提示: 如果当前网站在用户的黑名单中，打开侧边栏时会先弹出一个确认框，询问用户是否继续。

---

## 4. 选项页面 (Options)

选项页面提供了对扩展所有功能的深度自定义能力，采用清晰的两栏式布局。

### 4.1. UI 布局

1.  顶部操作栏:
    -   包含“导出配置”、“导入配置”、“重置为默认值”和“保存”四个全局操作按钮。

2.  左区导航栏，点击切换右区的配置项
    -   基础设置:
        -   本地数据管理 (显示缓存大小，页面数量和清除按钮)。
        -   默认模型选择，下拉菜单内容就是“语言模型”列表
        -   主题选择下拉列表 (浅色/深色/跟随系统)。
        -   语言选择 下拉列表(中/英)。
        -   全局系统提示词 (System Prompt) 输入框。
    -   内容提取设置:
        -   默认提取方式选择 (Readability/Jina)。
        -   选择Jina时，显示配置Jina AI 的 API Key。
        -   侧边栏内容展示区的默认高度。
    -   云同步:
        -   同步服务商选择 (GitHub Gist/WebDAV)。
        -   对应服务商的凭证配置输入框。
            - WebDAV：url，用户名，密码
            - GitHub：gist ID，令牌
        -   “保存时同步”的开关。手动同步按钮。
        -   同步状态显示区域。
    -   黑名单设置:
        -   一个可编辑的列表，用于管理不希望扩展运行的网站 URL 模式。
        -   提供添加、删除、重置为默认列表的操作。
    -   快捷指令 (Quick Input Tabs):
        -   一个可拖拽排序的列表，每一项代表一个快捷指令 Tab。
        -   每项包含“按钮显示文本”、“实际发送的指令内容”,“自动触发”的开关,分支模型多选下拉列表（去除删除和禁用的大模型）。
        -   提供添加和删除操作。
        -   响应式设计，tab和llm配置大屏幕显示3列，随屏幕缩小逐渐显示2列，1列，左区下面
    -   语言模型 (Language Models):
        -   一个可拖拽排序的列表，每一项代表一个可用的 LLM。
        -   每项包含模型名称、提供商 (OpenAI/Gemini/Azure)、API Key、Endpoint、模型 ID 等配置。
        -   提供添加和删除操作。
3. 使用 FloatingLabel 的输入框、多选框等，浮动标签在输入框聚焦或已有值时收起到顶部，并继承基础组件的错误提示、字数统计与多选联动能力。

### 4.2. 交互流程与功能

-   配置的保存: 任何修改都需要点击顶部的“保存”按钮才能生效。按钮会通过状态变化（如“未保存”、“保存中”、“已保存”、“错误”）提供清晰的视觉反馈。
-   导入/导出: 用户可以将所有配置（包括敏感的 API Key）打包成一个 JSON 文件导出，或从文件中导入。
-   动态表单: 页面上的某些选项是联动的。例如，只有当“内容提取方式”选择 Jina 时，Jina 的 API Key 输入框才会出现。
-   拖拽排序: 在“快捷指令”和“语言模型”区域，用户可以通过拖拽来调整各项的顺序，该顺序会直接反映在侧边栏的显示中。
-   云同步: 用户配置好 Gist 或 WebDAV 凭证并开启同步后，每次点击“保存”都会将最新的配置和数据（如聊天记录）上传到云端。

---

## 5. 会话页面 (Conversations)

这是一个独立的、全屏的页面，用于集中浏览和管理所有聊过天的网页。

### 5.1. UI 布局

1.  左侧列表栏:
    -   显示所有有过对话记录的网页列表，每一项包含页面图标 (Favicon) 和标题。
    -   列表顶部有一个搜索框，可以根据标题或 URL 快速筛选。
    -   列表宽度可拖拽调整。
    -   当没有任何历史记录时，会显示一个欢迎和引导信息的空状态。

2.  右侧内容栏:
    -   当未选择任何页面时，显示一个欢迎界面，引导用户从左侧选择。
    -   当选择了某个页面后，其布局和功能与侧边栏 (Sidebar) 几乎完全一致，包括顶部控制栏（部分功能隐藏）、内容展示区、快捷指令区和聊天交互区。
    -   唯一区别: 在内容展示区上方，会额外显示当前页面的完整标题（可点击inline修改）和可点击的 URL。

### 5.2. 交互流程与功能

-   会话浏览: 用户点击左侧列表中的任意一项，右侧会立刻加载该页面的缓存内容和全部聊天记录。
-   会话续聊: 用户可以在右侧的聊天交互区，基于已有的上下文继续与该页面进行对话，所有操作（发送、使用快捷指令等）均与侧边栏一致。
-   会话搜索: 在左侧搜索框输入关键词，列表会实时过滤，帮助用户快速定位到特定的历史会话。
-   会话管理:
    -   删除: 列表中的每一项右侧有删除按钮，用户可以彻底删除某个页面的所有相关数据（包括提取内容和聊天记录）。
    -   重命名: 用户可以直接点击右侧内容栏的页面标题，进入编辑模式，为其设置一个更易于识别的自定义名称。
-   直接访问: 支持通过 URL 参数 (`?selectPage=URL`) 的方式，直接打开并定位到某个特定的历史会话，方便从其他地方跳转。

---

## 6. 后台与内容脚本 (核心逻辑)

这两个模块没有用户界面，但在幕后驱动着整个扩展的运行。

### 6.1. 内容脚本 (Content Script)，假设

-   职责: 作为后台与网页之间的桥梁。
-   功能:
    -   被动响应后台的指令。
    -   核心功能是提供当前页面的完整 HTML 源码。
    -   它内置了一套智能判断机制，会等待页面（包括动态渲染的内容）完全加载后，再将 HTML 发送给后台，以确保数据的完整性。

### 6.2. 后台脚本 (Background)，假设

-   职责: 扩展的大脑，处理所有核心逻辑。
-   功能:
    -   事件监听: 监听浏览器的各种事件，如标签页切换、更新、扩展安装等，并触发相应的逻辑。
    -   消息路由: 接收来自侧边栏、选项页等前端界面的消息，并分发给相应的处理器执行。
    -   内容提取: 从内容脚本获取 HTML 后，在后台运行 Readability.js 或调用 Jina AI 服务来提取正文。
    -   LLM 通信: 管理与各大语言模型 API 的所有通信，包括组装 Prompt、发送请求、处理流式响应和错误。
    -   数据持久化: 负责将所有数据（配置、聊天记录、提取内容、页面状态等）存入 `chrome.storage.local`。        
    -   状态管理: 跟踪和管理进行中的 LLM 请求，支持取消操作。

---

## 7. 关键交互流程

本章节详细拆解几个核心的用户场景和系统内部处理流程。

### 7.1. 打开侧边栏

用户点击浏览器工具栏的扩展图标时，触发此流程。

1.  前置检查:
    -   Chrome 内部页面: 后台脚本首先判断当前页面是否为 `chrome://`、`edge://` 或 Chrome Web Store 等受限页面。如果是，则不会打开侧边栏，而是直接打开一个新标签页，显示独立的“会话历史页面”。
    -   黑名单检查: 如果不是内部页面，后台会检查当前页面的 URL 是否匹配用户在选项中设置的黑名单规则。
        -   如果匹配，侧边栏会打开，但内容区域会被一个确认框遮盖，提示用户“当前页面在黑名单中”，并提供“继续”或“关闭”两个选项。只有用户点击“继续”后，后续流程才会进行。
2.  内容提取与渲染:
    -   请求 HTML: 后台脚本向注入到页面的内容脚本发送消息，请求页面完整 HTML。内容脚本会等待页面完全加载后再返回数据，以确保动态内容被捕获。
    -   执行提取: 后台脚本收到 HTML 后，根据用户设置的默认提取方式（Readability.js 或 Jina AI）执行正文提取。
    -   处理提取结果:
        -   提取成功: 将提取到的内容缓存到本地存储，并发送给侧边栏 UI 进行显示。
        -   提取失败/内容为空: 侧边栏的内容展示区会显示“无法提取内容”的错误信息。
        -   重试机制: 用户可以点击顶部控制栏的“重新提取”按钮，手动触发一次完整的内容提取流程。

### 7.2. 切换浏览器标签页

- 自动关闭：切换标签页后，自动关闭侧边栏
- 同页面更改url：从已打开侧边栏的标签页 A，输入url切换到另一个页面 B 时，侧边栏会在新页面加载完成后自动开始加载标签页 B 的数据（重复 7.1 中的内容提取流程），而不是关闭。

### 7.3. LLM 调用与状态恢复

这是一个复杂但核心的流程，确保了异步操作的健壮性。

1.  调用过程:
    -   用户在侧边栏点击“发送”或快捷指令后，请求被发送到后台。
    -   后台脚本将该请求标记为“加载中”状态，并与当前页面的 URL 和对应的 Tab ID 绑定，存入一个全局的状态缓存中。
    -   Tab 状态呈现: 在侧边栏 UI 上，对应的快捷指令 Tab 会显示一个加载中的动画，同时输入框和发送按钮会被禁用，防止重复提交。
2.  中途切换标签页:
    -   如果在模型调用过程中，用户切换到了其他浏览器标签页，后台的 LLM 请求不会中断，会继续在后台运行。
    -   侧边栏 UI 会根据新激活的页面更新其显示内容。
3.  状态恢复:
    -   当用户再次切换回原来的页面时，后台脚本会检测到标签页激活事件。
    -   它会立刻查询全局的状态缓存，发现该页面的某个 Tab ID 仍处于“加载中”状态。
    -   后台脚本会将这个“加载中”的状态信息发送给侧边栏。
    -   侧边栏 UI 接收到信息后，会立即恢复到之前的状态——即对应的快捷指令 Tab 显示加载动画，输入框被禁用。
    -   当后台的 LLM 请求最终完成时，无论用户当前是否在该页面，后台都会将结果缓存。同时，它会尝试向侧边栏发送一个带有 Tab ID 的完成消息。如果用户恰好在该页面，对话记录就会被实时更新；如果不在，则消息发送失败，但数据已缓存，用户下次回到该页面时可以看到最终结果。

### 7.4. 云同步逻辑

同步功能旨在智能地合并本地和云端的数据，确保用户在任何设备上的修改都不会丢失。

-   触发时机: 用户在选项页面配置好同步参数并开启“保存时同步”后，每次点击“保存”按钮会触发一次完整的双向同步。
-   核心原则：基于时间戳的合并 (Last Write Wins)
    -   无论是配置项（如语言模型、快捷指令）还是数据项（如聊天记录、页面缓存），每一条独立的记录都包含一个 `lastModified` 时间戳。
    -   同步时，系统会同时获取本地和云端的数据，并对每一条记录（以其唯一ID或URL为标识）进行比较。
    -   合并规则:
        -   更新: 比较本地和云端同一条记录的 `lastModified` 时间戳，时间戳最新的记录将成为最终版本，覆盖掉较旧的版本。
        -   新增: 如果某条记录只在本地或只在云端存在，则直接将其复制到另一方。
-   配置项的同步:
    -   大模型配置 (Language Models) 和 快捷指令配置 (Quick Input Tabs) 同样遵循基于时间戳的合并规则。这意味着用户在一台设备上更新了某个模型的 API Key，在另一台设备上更新了另一个模型的名称，同步后这两项更改会同时保留，而不是互相覆盖。
    -   对于一些简单的、非列表型的基础配置（如主题、语言选择），则通常以用户当前操作的设备为准（即本地覆盖云端）。
-   删除操作的同步 (软删除):
    -   当用户在 UI 上删除一条记录时（例如一个快捷指令或一个历史会话），该记录并不会立即从本地数据库中消失。
    -   取而代之的是，系统会给这条记录打上一个 `isDeleted: true` 的标记，并更新其 `lastModified` 时间戳。
    -   在同步时，这个带有 `isDeleted` 标记的记录会被视为一次“更新”。其他设备接收到这个“更新”后，也会在本地将对应的记录标记为已删除，从而在 UI 上隐藏它。
    -   通过这种“软删除”机制，确保了删除操作可以像修改操作一样被可靠地同步到所有设备。在同步流程完全结束后，系统才会将这些已标记的记录从数据库中彻底清除。

### 7.5 确认
- 所有的删除操作，都会在点击位置弹出一个mini confirm的对话框，确认后进行操作

## 8. 外部依赖与资源

本章节列出了项目运行所依赖的关键第三方库和外部资源。

### 8.1. 功能库

-   Readability:
    -   用途: 作为核心的内容提取引擎之一。它能够解析完整的 HTML 源码，并智能地识别和提取出页面的主要文章内容，去除广告、导航栏等多余元素。

-   marked:
    -   用途: 将 LLM 返回的 Markdown 格式的回答实时转换为 HTML，以便在侧边栏和会话页面的聊天记录中正确地渲染代码块、列表、粗体等格式。

-   pako:
    -   用途: 一个高性能的 zlib 压缩/解压库。项目使用它来压缩需要存入本地 `chrome.storage` 的数据（如聊天记录、提取的页面内容），以减少存储空间的占用，并规避 Chrome 存储的大小限制。
    -   位置: 在后台脚本和所有需要与 `chrome.storage` 交互的前端页面（Sidebar, Options, Conversations）中都有使用。

### 8.2. UI 资源

-   本地Material Icons:
    -   用途: 为整个扩展提供统一的图标系统。所有界面上的图标（如发送、删除、设置、复制等）都来自于这个图标库。
    -   位置: 在所有具有 UI 的页面（Sidebar, Options, Conversations）中通过 CSS 引入和使用。

## 9. UI 组件体系与演示页面

- 在 components/ui 下实现统一的基础组件库，按照“布局 / 导航 / 展示 / 输入 / 反馈 / 辅助”分类，复用相同的主题令牌与直角无圆角风格。
- 组件库覆盖 AppShell、SplitPane、ScrollableArea、Tabs、ListNavigator、RichTextViewer、Badge、Button 系列、Select/MultiSelect、Switch、Toast、Modal、Tooltip 等需求文档中重复出现的交互模式。
- 	abs/ui-demo.tsx 新增“UI Demo” 页面，用于一次性预览全部基础组件，并提供主题切换、窗口分屏、滚动区域、表单控件、反馈状态等交互示例，便于设计和测试对齐视觉语言。
- Demo 页面结合 ToastProvider、Modal、MiniConfirmModal 等组件展示跨层反馈闭环，可作为 QA 与产品验收的参考入口。

